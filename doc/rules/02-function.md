# 2. 기능(Function) RULE — 일관성과 예측 가능성 [MUST]

> 원본: [RULE.md](../RULE.md) 2장.

### 2.1 API 설계 규칙 (OWASP A06:2025 Insecure Design)

> **A06:2025 Insecure Design** — 설계 단계 보안 결함. 위협 모델링 부족, 안전 설계 패턴 미적용.

#### 2.1.1 설계 원칙

- 모든 API는 **명확한 책임 단위**
- 위협 모델링: 신규 기능·API 설계 시 보안 위협 식별
- 하나의 API에서 아래 항목 혼합 금지:
  - 인증
  - 검증
  - 비즈니스 처리
  - 외부 연동

#### 2.1.2 강제

- HTTP Method 의미 준수
  - 조회: `GET`
  - 생성: `POST`
  - 수정: `PUT` / `PATCH`
  - 삭제: `DELETE`

#### 2.1.3 내부/관리자 API 분리 원칙

- 내부 API, Admin API는 외부 API와 **URL·보안 정책 분리**
  - 예: `/api/internal/**`, `/api/admin/**`
- Admin API는 **IP allow-list** 또는 **별도 인증 체계** 필수

> 실제 사고 다수: "운영용 API를 외부에서 호출 가능"

#### 2.1.4 URI 설계 규칙 — 계층형 자원 지향 (Resource-Oriented URI) [SHOULD]

> URI는 **자원(Resource)**을 나타내며, 행위는 HTTP Method로 표현한다. 소유/포함 관계는 슬래시(`/`)로 계층 표현.

##### 2.1.4.1 기본 원칙

| 순번 | 규칙                         | 예시 (O)                          | 예시 (X)                            | 비고                                       |
| ---- | ---------------------------- | --------------------------------- | ----------------------------------- | ------------------------------------------ |
| 1    | 명사 중심, 복수형 기본       | `/orders`, `/users`, `/comments`  | `/getOrder`, `/createUser`          | 동사는 HTTP Method로 표현                  |
| 2    | 계층은 소유/포함 관계일 때만 | `/orders/{orderId}/items`         | `/orderItems?orderId=123`           | 쿼리파라미터로 대체 가능하면 계층 X        |
| 3    | URI 최대 깊이 3~4단계 권장   | `/stores/45/products/812/reviews` | `.../a/b/c/d/e/f/g`                 | 4단계 이상 → 쿼리파라미터 또는 별도 리소스 |
| 4    | 식별자는 항상 `{camelCase}`  | `/users/{userId}`                 | `/users/userId`, `/users/:{userId}` | Spring 표준                                |
| 5    | 버전은 URI에 명시 (선택)     | `/api/v1/orders`                  | `/orders?v=1`                       | v1 생략 가능, v2부터 필수                  |
| 6    | 소문자 + 하이픈(-) 사용      | `/order-items`, `/user-profiles`  | `/orderItems`, `/user_profile`      | kebab-case 권장                            |

##### 2.1.4.2 기본 URI 패턴

| 패턴 | 용도                       | URI 예시                                      | HTTP Method            |
| ---- | -------------------------- | --------------------------------------------- | ---------------------- |
| 1    | 컬렉션 조회/생성           | `/resources`                                  | GET, POST              |
| 2    | 단일 리소스 조회/수정/삭제 | `/resources/{id}`                             | GET, PUT/PATCH, DELETE |
| 3    | 하위 컬렉션 조회/생성      | `/resources/{parentId}/sub-resources`         | GET, POST              |
| 4    | 하위 단일 리소스 CRUD      | `/resources/{parentId}/sub-resources/{subId}` | GET, PUT/PATCH, DELETE |
| 5    | 상태 변경 액션             | `/orders/{orderId}/cancel`                    | POST                   |
| 6    | 검색/필터링                | `/orders/search`, `/products?category=...`    | GET                    |
| 7    | 현재 사용자 관련           | `/me`, `/me/orders`, `/me/profile`            | —                      |

##### 2.1.4.3 금지 패턴

- ❌ 동사로 시작하는 URI (`/getUsers`, `/createOrder`, `/deleteItem`)
- ❌ 쿼리파라미터로 리소스 식별 (`/orders?orderId=123`)
- ❌ 과도한 계층 깊이 (`/a/b/c/d/e`)
- ❌ 대문자, 언더스코어, 카멜케이스 혼용

##### 2.1.4.4 버저닝 정책

- **v1**은 생략 가능 (`/api/orders`)
- **v2**부터는 반드시 명시 (`/api/v2/orders`)

### 2.2 예외 처리 규칙 (OWASP A10:2025 Mishandling of Exceptional Conditions)

> **A10:2025 Mishandling of Exceptional Conditions** — 예외·에러 처리 미흡. 스택 트레이스 노출, DoS 유발, 상태 불일치, 민감정보 유출 등. 2025 신규 카테고리.

#### 2.2.1 예외 처리 원칙

- **예외는 의도적으로 처리**
- 모든 예외는 의미 있는 에러 코드 또는 메시지 반환

#### 2.2.2 금지

- ❌ `try-catch`로 예외 무시
- ❌ `RuntimeException` 남발
- ❌ 에러 발생 시 `200 OK` 반환
- ❌ 스택 트레이스·내부 경로를 사용자 응답에 포함
- ❌ 예외 처리 미흡으로 인한 DoS·상태 불일치 허용

#### 2.2.3 공통 예외 체계 사용 (필수)

- 비즈니스 로직 예외는 반드시 공통 예외 체계(`BusinessException`, `ErrorCode`) 사용
- 예외 발생 시
  - 코드/메시지/HTTP 상태를 `ErrorCode enum`에 정의
  - 모든 예외는 `GlobalExceptionHandler`에서 잡아 일관된 `ErrorResponse`로 변환

#### 2.2.4 금지된 예외 종류 (Controller/Service 계층)

- **Controller·Service 계층**에서는 아래를 금지한다:
  - ❌ `IllegalArgumentException`, `IllegalStateException` 직접 사용 (비즈니스 실패는 `BusinessException` + `ErrorCode` 사용)
  - ❌ `RuntimeException`을 직접 상속하는 커스텀 예외(공통 체계 미적용)
  - ❌ `ErrorCode`와 무관한 기타 예외
- **도메인 모델 내부**(값 객체 생성자, 엔티티 불변식 검증 등)에서의 `IllegalArgumentException`, `IllegalStateException` 사용은 **예외**로 허용한다. 이는 "자기 방어적" 도메인 검증에 자연스러운 선택이다.

#### 2.2.5 ErrorCode 정의 가이드

- 신규 비즈니스 에러는 `ErrorCode`에 추가 후 공통 예외로만 사용
- `ErrorCode`는 enum에 코드/HTTP 상태/메시지 필수 지정
- 필요 시 도메인별 예외 클래스에 정적 팩토리 메서드 제공

#### 2.2.6 예외 유형 원칙 (Runtime 우선)

- **원칙**: 비즈니스·도메인 예외는 **Runtime 기반** 공통 예외 체계(`BusinessException` + `ErrorCode`)로 통합한다.
- **Checked Exception** 사용 시: Spring `@Transactional` 기본 동작은 `RuntimeException`만 롤백하므로, Checked Exception을 던지는 경우 **`rollbackFor`에 해당 예외를 명시**해야 트랜잭션 롤백이 보장된다. 외부 시스템 연동 등에서 Checked Exception이 의미 있는 경우에는 이렇게 명시 후 사용할 수 있다.
- **권장**: 신규 비즈니스 예외는 Runtime 기반으로 두고, Checked 사용 시 반드시 `rollbackFor` 문서화.

### 2.3 트랜잭션 규칙

#### 2.3.1 트랜잭션 경계

- 트랜잭션 경계는 **Service 계층**
- 읽기 전용 조회는 `readOnly = true`
- 외부 API 호출을 트랜잭션 내부에 두지 않는다

#### 2.3.2 트랜잭션과 이벤트

- **트랜잭션 내부에서 외부 이벤트 발행 금지**
- 반드시 **트랜잭션 커밋 이후** 발행
  - 예: `@TransactionalEventListener(phase = AFTER_COMMIT)`

> 롤백 후 메시지 발행 → 데이터 불일치 사고 다발

### 2.4 상태 관리

#### 2.4.1 상태 관리 원칙

- 서버는 가능한 한 **Stateless**
- **인증 우선순위**: 인증은 기본적으로 **JWT 기반 Stateless 방식**을 원칙으로 한다. 부득이하게 세션을 사용할 경우(하이브리드: Web 세션 + App 토큰 등)에만 스토리지를 분리·명시한다.
- 세션 사용 시:
  - 세션 스토리지 명시
  - 확장성 고려(Sticky session 전제 금지)

### 2.5 객체지향 설계 원칙 (SOLID) — 2026 우선순위 [MUST / SHOULD]

> SOLID 적용 시 **우선순위**를 반드시 지킨다. D·O 위반 시 코드 리뷰에서 반려 사유가 될 수 있다.

#### 2.5.1 왜 D와 O를 최우선으로 두었나?

- **DIP**와 **OCP**를 잘 지키면 → **의존성 방향이 깨끗**해지고 → **변경 전파**가 최소화된다.
- **OCP**를 지키지 못하면 → 기능 추가할 때마다 기존 핵심 코드가 계속 수정된다.
- **DIP**를 지키지 못하면 → 테스트가 어려워지고 → 모듈 교체/확장이 거의 불가능해진다.
- 나머지 S, L, I는 중요하지만, **D·O가 깨지면 시스템 전체의 유연성과 테스트 가능성이 급격히 떨어진다.**

#### 2.5.2 SOLID 적용 우선순위 (2026)

| 우선순위                                           | 원칙                               | 설명                                                                                           |
| -------------------------------------------------- | ---------------------------------- | ---------------------------------------------------------------------------------------------- |
| **1순위** (가장 중요 · 거의 예외 없음)             | **D** — 의존성 역전 원칙 (DIP)     | 고수준 모듈이 저수준 모듈에 직접 의존하지 않고, 추상화(인터페이스/추상 클래스)에 의존한다.     |
| **1순위**                                          | **O** — 개방-폐쇄 원칙 (OCP)       | 확장에는 열려 있고 수정에는 닫혀 있다. 새 기능 추가 시 기존 코드·switch/if-else 폭증을 피한다. |
| **2순위** (매우 중요 · 상황에 따라 trade-off 가능) | **S** — 단일 책임 원칙 (SRP)       | 한 클래스는 한 가지 변경 이유만 갖는다.                                                        |
| **2순위**                                          | **L** — 리스코프 치환 원칙 (LSP)   | 자식 타입이 부모 타입으로 치환되어도 프로그램의 정확성이 깨지지 않는다.                        |
| **2순위**                                          | **I** — 인터페이스 분리 원칙 (ISP) | 클라이언트가 사용하지 않는 메서드에 의존하지 않도록 인터페이스를 적절히 분리한다.              |

#### 2.5.3 SOLID 준수 레벨 기준 (리뷰 시 점수화)

| 우선순위 | 원칙    | 레벨 기준 (0~5점)                   | 비고                               |
| -------- | ------- | ----------------------------------- | ---------------------------------- |
| ★★★★★    | DIP (D) | 반드시 지켜야 함 (0점 = merge 불가) | 의존성 방향이 깨지면 리팩토링 필수 |
| ★★★★★    | OCP (O) | 반드시 지켜야 함 (0점 = merge 불가) | switch/if-else 폭증 시 위반        |
| ★★★★     | SRP (S) | 3점 이하 시 리뷰어와 논의 필수      | 너무 잘게 쪼개는 것도 문제         |
| ★★★      | LSP (L) | 위반 시 심각도 중간~높음            | 상속 구조에서 자주 발생            |
| ★★★      | ISP (I) | 위반 시 심각도 낮음~중간            | 인터페이스 비대화 방지             |

#### 2.5.4 코드 리뷰·PR 시 요약 문구

- **리뷰 코멘트나 PR 템플릿에 사용:**
  _"이번 변경은 D와 O를 최우선으로 지켰는가? D와 O를 어겼다면 반드시 이유를 설명해 주세요."_
- **DIP·OCP 중 하나라도 위반 시** → PR 설명란에 **반드시 이유**를 남긴다.

#### 2.5.5 SOLID 준수 자기 체크리스트 (PR / Definition of Done)

- [ ] **DIP** : 고수준 모듈이 저수준 모듈에 의존하지 않도록 **추상화(인터페이스/추상 클래스)**에 의존했는가?
- [ ] **OCP** : 새로운 기능을 추가할 때 **기존 코드를 수정(또는 switch문 추가)**하지 않아도 되는 구조인가?
- [ ] **SRP** : 이 클래스가 **변경되는 이유가 1~2개 이하**인가? (3개 이상이면 분리 검토)
- [ ] **LSP** : 자식 클래스가 부모 타입으로 치환됐을 때 **프로그램의 correctness가 깨지지 않는가?**
- [ ] **ISP** : 클라이언트가 **필요 없는 메소드에 의존하지 않도록** 인터페이스가 적절히 분리됐는가?

※ **DIP와 OCP 중 하나라도 위반 시 반드시 설명**을 PR 설명란에 남긴다.
